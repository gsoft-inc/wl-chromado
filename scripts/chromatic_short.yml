variables:
  - group: Azure DevOps

steps:
  # Accepting the baseline automatically when Chromatic is executed on the "main" branch.
  # Running Chromatic on the "main" branch allow us to use "squash" merge for PRs, see: https://www.chromatic.com/docs/custom-ci-provider/#squashrebase-merge-and-the-main-branch.
  # Furthermore, changes from PR doesn't seem to be updating the baseline at all but I don't know why, it seems like a bug with ADO.
  - task: CmdLine@2
    displayName: Chromatic (main branch)
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    inputs:
      - script: pnpm dlx chromatic --only-changed --skip renovate/** --auto-accept-changes main
    env:
      CHROMATIC_PROJECT_TOKEN: $(CHROMATIC_PROJECT_TOKEN)

  - task: CmdLine@2
    displayName: Chromatic (PR)
    condition: eq(variables['Build.Reason'], 'PullRequest')
    inputs:
      - script: pnpm dlx @workleap/chromatic-ado --only-changed --skip renovate/**
    env:
      CHROMATIC_PROJECT_TOKEN: $(CHROMATIC_PROJECT_TOKEN)
      PULL_REQUEST_COMMENT_ACCESS_TOKEN: $(PULL_REQUEST_COMMENT_ACCESS_TOKEN)
